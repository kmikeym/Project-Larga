<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Larga - Story Development Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #fafafa;
      min-height: 100vh;
      padding: 0;
      color: #111;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    header {
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 30px;
      margin-bottom: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      flex: 1;
    }

    .header-nav {
      display: flex;
      gap: 10px;
    }

    h1 {
      font-size: 2em;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    .tagline {
      font-size: 0.9em;
      color: #666;
      font-weight: 400;
    }

    .upload-section {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 20px;
      margin-bottom: 40px;
    }

    .upload-zone {
      border: 1px dashed #ccc;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }

    .upload-zone:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .upload-zone.dragging {
      background: #f0f0f0;
      border-color: #111;
    }

    .upload-icon {
      font-size: 1.5em;
      margin-bottom: 6px;
    }

    .upload-zone h3 {
      font-size: 0.9em;
      font-weight: 500;
      margin-bottom: 4px;
    }

    #fileInput {
      display: none;
    }

    .btn {
      background: #111;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .btn:hover {
      background: #333;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1px;
      background: #e0e0e0;
      border: 1px solid #e0e0e0;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.8em;
      font-weight: 600;
      color: #111;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }

    .stat-label {
      color: #666;
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .timeline-section {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 0;
    }

    .timeline-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .timeline-header h2 {
      font-size: 1em;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .timeline {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
      gap: 1px;
      background: #e0e0e0;
    }

    .timeline-item {
      background: white;
      padding: 20px;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
    }

    .timeline-item:hover {
      background: #fafafa;
    }

    .timeline-content {
      background: transparent;
      padding: 0;
    }

    .timeline-date {
      color: #999;
      font-weight: 400;
      margin-bottom: 8px;
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: left;
    }

    .timeline-title {
      font-size: 1.1em;
      font-weight: 600;
      color: #111;
      margin-bottom: 12px;
      letter-spacing: -0.01em;
      text-align: left;
    }

    .timeline-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
      justify-content: flex-start;
    }

    .meta-badge {
      background: #f0f0f0;
      color: #666;
      padding: 4px 8px;
      font-size: 0.7em;
      font-weight: 500;
      border: 1px solid #e0e0e0;
    }

    .document-details {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .section-list {
      margin-top: 10px;
    }

    .section-item {
      background: #fafafa;
      padding: 6px 8px;
      margin: 3px 0;
      font-size: 0.8em;
      border-left: 2px solid #e0e0e0;
    }

    .section-title {
      font-weight: 600;
      color: #111;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
    }

    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .success {
      background: #efe;
      border: 1px solid #cfc;
      color: #3c3;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .character-list, .theme-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .character-tag, .theme-tag {
      background: #764ba2;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8em;
    }

    .theme-tag {
      background: #f59e0b;
    }

    .confidence-high {
      background: #10b981;
      color: white;
      padding: 6px 10px;
      font-size: 0.8em;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 2px 0;
    }

    .confidence-medium {
      background: #fbbf24;
      color: #111;
      padding: 6px 10px;
      font-size: 0.8em;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 2px 0;
    }

    .confidence-low {
      background: #ef4444;
      color: white;
      padding: 6px 10px;
      font-size: 0.8em;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 2px 0;
    }

    .remove-tag-btn {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 1em;
      padding: 0;
      margin-left: 4px;
      opacity: 0.7;
    }

    .remove-tag-btn:hover {
      opacity: 1;
    }

    .add-item-form {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      align-items: center;
    }

    .add-item-input {
      padding: 6px 10px;
      border: 1px solid #e0e0e0;
      font-size: 0.8em;
      flex: 1;
      max-width: 200px;
    }

    .add-item-btn {
      background: #111;
      color: white;
      border: none;
      padding: 6px 12px;
      font-size: 0.8em;
      cursor: pointer;
      white-space: nowrap;
    }

    .add-item-btn:hover {
      background: #333;
    }

    .detail-section {
      margin-top: 15px;
      padding: 0;
    }

    .detail-section-title {
      font-weight: 600;
      font-size: 0.9em;
      margin-bottom: 10px;
      display: block;
    }

    .items-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }

    .update-grid-btn {
      background: #111;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 0.85em;
      cursor: pointer;
      margin-top: 15px;
      font-weight: 500;
    }

    .update-grid-btn:hover {
      background: #333;
    }

    .read-full-btn {
      background: #666;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 0.85em;
      cursor: pointer;
      margin-top: 15px;
      font-weight: 500;
    }

    .read-full-btn:hover {
      background: #444;
    }

    .full-document-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }

    .full-document-content {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      border: 1px solid #e0e0e0;
      padding: 40px;
    }

    .full-document-text {
      white-space: pre-wrap;
      font-family: 'Georgia', serif;
      line-height: 1.8;
      color: #111;
      font-size: 1em;
    }

    .close-modal-btn {
      background: #111;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 0.9em;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .close-modal-btn:hover {
      background: #333;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      transition: background 0.2s;
      margin-top: 10px;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    .document-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .document-info {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <h1>üé¨ Larga</h1>
        <p class="tagline">Story Development Tracker</p>
      </div>
      <div style="flex: 1; display: flex; justify-content: center;" id="projectSwitcher">
        <!-- Project switcher will be injected here -->
      </div>
      <div class="header-nav">
        <button class="btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
        <a href="/grid.html" class="btn">üìä Story Grid</a>
      </div>
    </header>

    <!-- Settings Modal -->
    <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px; overflow-y: auto;">
      <div style="max-width: 900px; margin: 60px auto; background: white; border: 1px solid #e0e0e0; padding: 30px; max-height: calc(100vh - 120px); overflow-y: auto;">
        <h2 style="margin-bottom: 20px;">Settings</h2>

        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">AI Model Provider</label>
          <select id="aiModelSelect" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; font-size: 1em;">
            <option value="openai/gpt-4o">GPT-4o (OpenAI) - Recommended for creative content</option>
            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (Anthropic)</option>
            <option value="anthropic/claude-3-opus">Claude 3 Opus (Anthropic)</option>
            <option value="anthropic/claude-3-haiku">Claude 3 Haiku (Anthropic)</option>
            <option value="google/gemini-pro-1.5">Gemini Pro 1.5 (Google)</option>
            <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B (Meta)</option>
          </select>
          <p style="margin-top: 8px; font-size: 0.85em; color: #666;">
            All models route through OpenRouter. Default: GPT-4o
          </p>
          <div style="margin-top: 12px; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
            <p style="font-size: 0.85em; color: #856404; margin: 0;">
              ‚ö†Ô∏è <strong>Note:</strong> Claude models often block dramatic/violent content due to AWS Bedrock moderation, even for fictional TV/film scripts. GPT-4o is recommended for creative content.
            </p>
          </div>
        </div>

        <!-- AI Prompts Section -->
        <div style="margin-bottom: 25px; border-top: 1px solid #e0e0e0; padding-top: 25px;">
          <h3 style="margin-bottom: 15px; font-size: 1.1em;">AI Analysis Prompts</h3>
          <p style="margin-bottom: 15px; font-size: 0.85em; color: #666;">
            Customize how AI analyzes different document types. Changes are per-project.
          </p>

          <!-- Notes Prompt -->
          <div style="margin-bottom: 20px; padding: 15px; background: #fafafa; border: 1px solid #e0e0e0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <label style="font-weight: 500;">Notes/Feedback Documents</label>
              <button class="btn" style="padding: 4px 10px; font-size: 0.8em;" onclick="resetPrompt('notes')">Reset to Default</button>
            </div>
            <select id="promptModel_notes" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; margin-bottom: 8px; font-size: 0.9em;">
              <option value="openai/gpt-4o">GPT-4o (OpenAI)</option>
              <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
              <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
              <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
            </select>
            <textarea id="promptText_notes" style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #e0e0e0; font-family: monospace; font-size: 0.85em; resize: vertical;"></textarea>
          </div>

          <!-- Beat Sheet Prompt -->
          <div style="margin-bottom: 20px; padding: 15px; background: #fafafa; border: 1px solid #e0e0e0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <label style="font-weight: 500;">Beat Sheet Documents</label>
              <button class="btn" style="padding: 4px 10px; font-size: 0.8em;" onclick="resetPrompt('beatSheet')">Reset to Default</button>
            </div>
            <select id="promptModel_beatSheet" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; margin-bottom: 8px; font-size: 0.9em;">
              <option value="openai/gpt-4o">GPT-4o (OpenAI)</option>
              <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
              <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
              <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
            </select>
            <textarea id="promptText_beatSheet" style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #e0e0e0; font-family: monospace; font-size: 0.85em; resize: vertical;"></textarea>
          </div>

          <!-- Session Notes Prompt -->
          <div style="margin-bottom: 20px; padding: 15px; background: #fafafa; border: 1px solid #e0e0e0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <label style="font-weight: 500;">Session/Brainstorming Notes</label>
              <button class="btn" style="padding: 4px 10px; font-size: 0.8em;" onclick="resetPrompt('sessionNotes')">Reset to Default</button>
            </div>
            <select id="promptModel_sessionNotes" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; margin-bottom: 8px; font-size: 0.9em;">
              <option value="openai/gpt-4o">GPT-4o (OpenAI)</option>
              <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
              <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
              <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
            </select>
            <textarea id="promptText_sessionNotes" style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #e0e0e0; font-family: monospace; font-size: 0.85em; resize: vertical;"></textarea>
          </div>

          <!-- Default Prompt -->
          <div style="margin-bottom: 20px; padding: 15px; background: #fafafa; border: 1px solid #e0e0e0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <label style="font-weight: 500;">Default (Other Documents)</label>
              <button class="btn" style="padding: 4px 10px; font-size: 0.8em;" onclick="resetPrompt('default')">Reset to Default</button>
            </div>
            <select id="promptModel_default" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; margin-bottom: 8px; font-size: 0.9em;">
              <option value="openai/gpt-4o">GPT-4o (OpenAI)</option>
              <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
              <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
              <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
            </select>
            <textarea id="promptText_default" style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #e0e0e0; font-family: monospace; font-size: 0.85em; resize: vertical;"></textarea>
          </div>
        </div>

        <div style="margin-bottom: 25px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="skipConfirmation" style="margin-right: 8px;">
            <span>Skip confirmation dialogs for delete operations</span>
          </label>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button class="btn" onclick="closeSettings()">Cancel</button>
          <button class="btn" style="background: #111; color: white;" onclick="saveSettings()">Save Settings</button>
        </div>
      </div>
    </div>

    <div class="upload-section">
      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">üìÑ</div>
        <h3>Drop your document here</h3>
        <p style="margin: 10px 0; color: #999; font-size: 0.9em;">Supports .docx, .pdf, .rtf</p>
        <p style="margin: 5px 0; color: #999; font-size: 0.75em;">(.pages files: export to PDF first)</p>
        <button class="btn" onclick="document.getElementById('fileInput').click()">
          Choose File
        </button>
        <input type="file" id="fileInput" accept=".docx,.pdf,.rtf,.pages" />
      </div>
      <div id="uploadStatus"></div>
    </div>

    <div class="stats-grid" id="statsGrid"></div>

    <div class="timeline-section">
      <div class="timeline-header">
        <h2>Project Timeline</h2>
      </div>
      <div id="timelineContent" class="loading">Loading...</div>
    </div>
  </div>

  <script src="/project-utils.js"></script>
  <script>
    const API_BASE = window.location.origin;

    // Initialize project switcher
    ProjectUtils.renderProjectSwitcher('projectSwitcher');

    // Settings management
    let defaultPrompts = null; // Will be loaded from server

    function loadSettings() {
      const settings = {
        aiModel: localStorage.getItem('aiModel') || 'openai/gpt-4o',
        skipConfirmation: localStorage.getItem('skipConfirmation') === 'true'
      };
      return settings;
    }

    function saveSettingsToStorage(aiModel, skipConfirmation) {
      localStorage.setItem('aiModel', aiModel);
      localStorage.setItem('skipConfirmation', skipConfirmation);
    }

    async function openSettings() {
      const settings = loadSettings();
      document.getElementById('aiModelSelect').value = settings.aiModel;
      document.getElementById('skipConfirmation').checked = settings.skipConfirmation;

      // Load project-specific AI prompts
      try {
        const projectId = ProjectUtils.getCurrentProjectId();
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/projects/${projectId}/settings`);
        const data = await response.json();

        if (data.success && data.settings && data.settings.aiPrompts) {
          const prompts = data.settings.aiPrompts;

          // Store defaults for reset functionality
          defaultPrompts = prompts;

          // Populate form fields
          ['notes', 'beatSheet', 'sessionNotes', 'default'].forEach(type => {
            if (prompts[type]) {
              document.getElementById(`promptModel_${type}`).value = prompts[type].model || 'openai/gpt-4o';
              document.getElementById(`promptText_${type}`).value = prompts[type].prompt || '';
            }
          });
        }
      } catch (error) {
        console.error('Error loading AI prompts:', error);
        showMessage('error', 'Failed to load AI prompts');
      }

      document.getElementById('settingsModal').style.display = 'block';
    }

    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    async function resetPrompt(type) {
      if (!defaultPrompts || !defaultPrompts[type]) {
        showMessage('error', 'Default prompts not loaded');
        return;
      }

      const prompt = defaultPrompts[type];
      document.getElementById(`promptModel_${type}`).value = prompt.model || 'openai/gpt-4o';
      document.getElementById(`promptText_${type}`).value = prompt.prompt || '';
      showMessage('success', `Reset ${type} prompt to default`);
    }

    async function saveSettings() {
      const aiModel = document.getElementById('aiModelSelect').value;
      const skipConfirmation = document.getElementById('skipConfirmation').checked;
      saveSettingsToStorage(aiModel, skipConfirmation);

      // Save AI prompts to project settings
      try {
        const aiPrompts = {
          notes: {
            model: document.getElementById('promptModel_notes').value,
            prompt: document.getElementById('promptText_notes').value
          },
          beatSheet: {
            model: document.getElementById('promptModel_beatSheet').value,
            prompt: document.getElementById('promptText_beatSheet').value
          },
          sessionNotes: {
            model: document.getElementById('promptModel_sessionNotes').value,
            prompt: document.getElementById('promptText_sessionNotes').value
          },
          default: {
            model: document.getElementById('promptModel_default').value,
            prompt: document.getElementById('promptText_default').value
          }
        };

        const projectId = ProjectUtils.getCurrentProjectId();
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/projects/${projectId}/settings`, {
          method: 'POST',
          body: JSON.stringify({ aiPrompts })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to save settings');
        }

        closeSettings();
        showMessage('success', 'Settings saved successfully');
      } catch (error) {
        console.error('Error saving AI prompts:', error);
        showMessage('error', 'Failed to save AI prompts: ' + error.message);
      }
    }

    // File upload handling
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');

    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragging');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragging');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragging');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    });

    async function handleFileUpload(file) {
      const allowedExtensions = ['.docx', '.pdf', '.rtf'];
      const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

      if (fileExt === '.pages') {
        showMessage('error', '.pages files are not supported. Please export your document to PDF or DOCX from Pages first.');
        return;
      }

      if (!allowedExtensions.includes(fileExt)) {
        showMessage('error', 'Please upload a .docx, .pdf, or .rtf file');
        return;
      }

      const formData = new FormData();
      formData.append('document', file);

      showMessage('loading', `Uploading ${file.name}...`);

      try {
        const response = await fetch(`${API_BASE}/api/upload?projectId=${ProjectUtils.getCurrentProjectId()}`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          showMessage('success', `Document uploaded successfully! Found ${data.document.sections.length} sections, ${data.document.characters.length} characters.`);
          fileInput.value = '';
          loadTimeline();
        } else {
          showMessage('error', data.error || 'Upload failed');
        }
      } catch (error) {
        showMessage('error', `Upload failed: ${error.message}`);
      }
    }

    function showMessage(type, message) {
      uploadStatus.className = type;
      uploadStatus.textContent = message;

      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          uploadStatus.textContent = '';
          uploadStatus.className = '';
        }, 5000);
      }
    }

    // Load timeline and stats
    async function loadTimeline() {
      const timelineContent = document.getElementById('timelineContent');

      try {
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/timeline`);
        const data = await response.json();

        // Update stats
        updateStats(data.stats);

        // Update timeline
        if (data.documents.length === 0) {
          timelineContent.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <h3>No documents yet</h3>
              <p>Upload your first document to get started</p>
            </div>
          `;
        } else {
          timelineContent.innerHTML = `
            <div class="timeline">
              ${data.documents.map(doc => renderTimelineItem(doc)).join('')}
            </div>
          `;
        }
      } catch (error) {
        timelineContent.innerHTML = `
          <div class="error">
            Failed to load timeline: ${error.message}
          </div>
        `;
      }
    }

    function updateStats(stats) {
      const statsGrid = document.getElementById('statsGrid');

      const daySpan = stats.firstDate && stats.lastDate
        ? Math.ceil((new Date(stats.lastDate) - new Date(stats.firstDate)) / (1000 * 60 * 60 * 24))
        : 0;

      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${stats.totalDocuments}</div>
          <div class="stat-label">Documents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.totalWords.toLocaleString()}</div>
          <div class="stat-label">Total Words</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.allCharacters.length}</div>
          <div class="stat-label">Characters</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${daySpan}</div>
          <div class="stat-label">Days</div>
        </div>
      `;
    }

    function renderTimelineItem(doc) {
      const date = new Date(doc.date);
      const formattedDate = date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      // Apply document type styling
      const styleAttr = doc.style ?
        `style="background-color: ${doc.style.backgroundColor}; color: ${doc.style.color}; border: ${doc.style.border};"` :
        '';

      return `
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div class="timeline-content" ${styleAttr}>
            <div class="document-info" onclick="toggleDetails('${doc.id}')">
              <div class="timeline-date">${formattedDate}</div>
              <div class="timeline-title">üìÑ ${doc.filename}</div>
              <div class="timeline-meta">
                <span class="meta-badge">${doc.type}</span>
                <span class="meta-badge">${doc.wordCount.toLocaleString()} words</span>
                <span class="meta-badge">${(doc.sections || []).length} sections</span>
                ${doc.aiEnhanced ? `<span class="meta-badge" style="background: #10b981; color: white;">ü§ñ ${doc.aiModel ? doc.aiModel.split('/')[1] : 'AI Enhanced'}</span>` : ''}
              </div>
              ${doc.summary ? `<div style="margin-top: 10px; color: #666; font-size: 0.8em;">${doc.summary}</div>` : ''}
              ${doc.genre ? `<div style="margin-top: 5px;"><span class="meta-badge" style="background: #111; color: white;">Genre: ${doc.genre}</span></div>` : ''}
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
              <button id="analyze-btn-${doc.id}" class="btn" onclick="event.stopPropagation(); analyzeWithAI('${doc.id}')">
                ü§ñ ${doc.aiEnhanced ? 'Re-analyze' : 'Analyze'}
              </button>
              <button class="btn" onclick="event.stopPropagation(); selectCompareDoc('${doc.id}', '${doc.filename}')">
                üìä Compare
              </button>
              <button class="btn" onclick="event.stopPropagation(); deleteDocument('${doc.id}', '${doc.filename}')">
                üóëÔ∏è Delete
              </button>
            </div>
            <div id="details-${doc.id}" class="document-details" style="display: none;">
              <div class="detail-section">
                <span class="detail-section-title">Characters (${(doc.characters || []).length}):</span>
                <div class="items-list" id="characters-list-${doc.id}">
                  ${renderCharactersWithConfidence(doc.characters || [], doc.id)}
                </div>
                <div class="add-item-form">
                  <input type="text" class="add-item-input" id="new-character-${doc.id}" placeholder="Add character...">
                  <button class="add-item-btn" onclick="event.stopPropagation(); addCharacter('${doc.id}')">+ Add</button>
                </div>
              </div>

              <div class="detail-section">
                <span class="detail-section-title">Themes (${(doc.themes || []).length}):</span>
                <div class="items-list" id="themes-list-${doc.id}">
                  ${renderThemesWithConfidence(doc.themes || [], doc.id)}
                </div>
                <div class="add-item-form">
                  <input type="text" class="add-item-input" id="new-theme-${doc.id}" placeholder="Add theme...">
                  <button class="add-item-btn" onclick="event.stopPropagation(); addTheme('${doc.id}')">+ Add</button>
                </div>
              </div>

              <div class="detail-section">
                <span class="detail-section-title">Sections (${(doc.sections || []).length}):</span>
                <div class="section-list">
                  ${(doc.sections || []).map(s => `
                    <div class="section-item">
                      <div class="section-title">${s.title}</div>
                      <div style="color: #999; font-size: 0.85em;">${s.wordCount} words</div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <button class="read-full-btn" onclick="event.stopPropagation(); readFullDocument('${doc.id}', '${doc.filename}')">
                  üìñ Read Full Document
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function toggleDetails(id) {
      const details = document.getElementById(`details-${id}`);
      details.style.display = details.style.display === 'none' ? 'block' : 'none';
    }

    async function deleteDocument(id, filename) {
      const settings = loadSettings();
      if (!settings.skipConfirmation) {
        if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis action cannot be undone.`)) {
          return;
        }
      }

      try {
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/documents/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showMessage('success', 'Document deleted successfully');
          loadTimeline();
        } else {
          showMessage('error', data.error || 'Delete failed');
        }
      } catch (error) {
        showMessage('error', `Delete failed: ${error.message}`);
      }
    }

    async function analyzeWithAI(id) {
      const settings = loadSettings();
      const modelName = settings.aiModel.split('/')[1] || settings.aiModel;

      // Skip confirmation, start analysis immediately
      // Update button to show loading state
      const btn = document.getElementById(`analyze-btn-${id}`);
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Analyzing...';
      btn.style.opacity = '0.7';
      btn.style.cursor = 'not-allowed';

      showMessage('loading', `Analyzing with ${modelName}... This may take 10-30 seconds.`);

      try {
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/documents/${id}/analyze`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ model: settings.aiModel })
        });

        const data = await response.json();

        if (data.success) {
          showMessage('success', 'AI analysis complete! Document updated.');
          loadTimeline();
        } else {
          showMessage('error', data.error || 'AI analysis failed');
          // Restore button on error
          btn.disabled = false;
          btn.innerHTML = originalText;
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        }
      } catch (error) {
        showMessage('error', `AI analysis failed: ${error.message}`);
        // Restore button on error
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      }
    }

    // Comparison feature
    let compareDoc1 = null;

    function selectCompareDoc(id, filename) {
      if (!compareDoc1) {
        // First document selected
        compareDoc1 = { id, filename };
        alert(`Selected: "${filename}"\n\nNow click "üìä Compare" on another document to see the differences.`);
      } else {
        // Second document selected - navigate to comparison
        window.location.href = `/compare.html?id1=${compareDoc1.id}&id2=${id}`;
      }
    }

    // Helper functions for rendering characters and themes with confidence
    function assignConfidence(items) {
      // Simple heuristic: divide items into thirds
      // High confidence: first 40%
      // Medium confidence: next 40%
      // Low confidence: last 20%
      return items.map((item, index) => {
        const position = index / items.length;
        let confidence = 'high';
        if (position >= 0.4 && position < 0.8) {
          confidence = 'medium';
        } else if (position >= 0.8) {
          confidence = 'low';
        }
        return { name: item, confidence };
      });
    }

    function renderCharactersWithConfidence(characters, docId) {
      if (!characters || characters.length === 0) {
        return '<div style="color: #999; font-size: 0.8em;">No characters detected</div>';
      }

      const withConfidence = assignConfidence(characters);
      return withConfidence.map(char => `
        <div class="confidence-${char.confidence}">
          <span>${char.name}</span>
          <button class="remove-tag-btn" onclick="event.stopPropagation(); removeCharacter('${docId}', '${char.name}')">√ó</button>
        </div>
      `).join('');
    }

    function renderThemesWithConfidence(themes, docId) {
      if (!themes || themes.length === 0) {
        return '<div style="color: #999; font-size: 0.8em;">No themes detected</div>';
      }

      const withConfidence = assignConfidence(themes);
      return withConfidence.map(theme => `
        <div class="confidence-${theme.confidence}">
          <span>${theme.name}</span>
          <button class="remove-tag-btn" onclick="event.stopPropagation(); removeTheme('${docId}', '${theme.name}')">√ó</button>
        </div>
      `).join('');
    }

    // Add character
    async function addCharacter(docId) {
      const input = document.getElementById(`new-character-${docId}`);
      const newCharacter = input.value.trim();

      if (!newCharacter) {
        alert('Please enter a character name');
        return;
      }

      try {
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/documents/${docId}/characters`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ character: newCharacter })
        });

        const data = await response.json();

        if (data.success) {
          input.value = '';
          loadTimeline(); // Refresh to show updated list
        } else {
          alert(data.error || 'Failed to add character');
        }
      } catch (error) {
        alert(`Failed to add character: ${error.message}`);
      }
    }

    // Remove character
    async function removeCharacter(docId, character) {
      try {
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/documents/${docId}/characters`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ character })
        });

        const data = await response.json();

        if (data.success) {
          loadTimeline(); // Refresh to show updated list
        } else {
          alert(data.error || 'Failed to remove character');
        }
      } catch (error) {
        alert(`Failed to remove character: ${error.message}`);
      }
    }

    // Add theme
    async function addTheme(docId) {
      const input = document.getElementById(`new-theme-${docId}`);
      const newTheme = input.value.trim();

      if (!newTheme) {
        alert('Please enter a theme');
        return;
      }

      try {
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/documents/${docId}/themes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ theme: newTheme })
        });

        const data = await response.json();

        if (data.success) {
          input.value = '';
          loadTimeline(); // Refresh to show updated list
        } else {
          alert(data.error || 'Failed to add theme');
        }
      } catch (error) {
        alert(`Failed to add theme: ${error.message}`);
      }
    }

    // Remove theme
    async function removeTheme(docId, theme) {
      try {
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/documents/${docId}/themes`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ theme })
        });

        const data = await response.json();

        if (data.success) {
          loadTimeline(); // Refresh to show updated list
        } else {
          alert(data.error || 'Failed to remove theme');
        }
      } catch (error) {
        alert(`Failed to remove theme: ${error.message}`);
      }
    }

    // Read full document
    async function readFullDocument(docId, filename) {
      try {
        const response = await ProjectUtils.fetchWithProject(`${API_BASE}/api/documents/${docId}/text`);
        const data = await response.json();

        if (data.success) {
          // Create modal
          const modal = document.createElement('div');
          modal.className = 'full-document-modal';
          modal.innerHTML = `
            <div class="full-document-content">
              <button class="close-modal-btn" onclick="this.closest('.full-document-modal').remove()">‚Üê Close</button>
              <h2 style="margin-bottom: 20px;">${filename}</h2>
              <div class="full-document-text">${data.text}</div>
            </div>
          `;
          document.body.appendChild(modal);
          modal.style.display = 'block';

          // Close on background click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        } else {
          alert(data.error || 'Failed to load document text');
        }
      } catch (error) {
        alert(`Failed to load document: ${error.message}`);
      }
    }

    // Load timeline on page load
    loadTimeline();
  </script>
</body>
</html>
